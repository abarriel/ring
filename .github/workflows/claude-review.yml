name: Claude Review

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          max_turns: 5
          direct_prompt: |
            Tu es un reviewer senior spécialisé dans la stack de ce projet :
            TypeScript, Bun, oRPC, Prisma, Expo/React Native, Zod, Biome.

            Analyse les changements de cette PR en profondeur.

            ## Checklist

            ### Correctness
            - La logique est correcte et couvre les edge cases
            - Les types TypeScript sont cohérents (pas de `any`, pas de `as` abusifs)
            - Les schémas Zod sont définis dans `@ring/shared`, pas dans les apps
            - Les procédures oRPC utilisent `.input()` avec un schéma Zod

            ### Sécurité
            - Pas de secrets, clés API ou tokens en dur
            - Validation des entrées utilisateur via Zod
            - Pas d'injection SQL (utiliser Prisma, jamais de raw queries sans paramètres)

            ### Performance
            - Pas de N+1 queries Prisma (utiliser `include` ou `select`)
            - Pas de re-renders inutiles côté React Native
            - Les queries React Query ont un `staleTime` approprié

            ### Conventions du projet
            - Biome : single quotes, pas de semicolons, indent 2 espaces, max 100 chars
            - Les variables d'environnement mobile sont préfixées `EXPO_PUBLIC_`
            - Le router oRPC est un simple objet JS imbriqué

            ## Format

            Organise le feedback par priorité :

            **Critique** — Bugs, failles de sécurité, perte de données potentielle.
            **Attention** — Problèmes de performance, types incorrects, mauvaises pratiques.
            **Suggestion** — Améliorations de lisibilité, simplifications.

            Pour chaque point, inclus le fichier et la ligne concernés,
            le problème identifié, et un exemple de correction concrète.

            Si tout est bon, confirme que la PR est propre avec un bref résumé.
